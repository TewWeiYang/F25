<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Collectible Puzzle System - Spring Town Map</title>

<style>
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: linear-gradient(180deg, #eaf8df, #f7fff3);
  text-align: center;
  color: #333;
}

/* UI Header */
.hero { padding: 24px 16px 10px; }
.hero h1 { margin: 0; font-size: 28px; }
.hero p { margin-top: 6px; font-size: 14px; color: #666; }

/* Progress info */
.progress-card {
  display: flex;
  justify-content: space-around;
  background: #fff;
  border-radius: 14px;
  padding: 12px;
  margin: 10px auto 16px;
  max-width: 360px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.08);
}
.progress-card div { font-size: 13px; }
.progress-card strong { display: block; margin-bottom: 4px; }

/* Buttons */
button {
  background: linear-gradient(135deg, #ff9a00, #ff6a00);
  color: #fff;
  border: none;
  border-radius: 30px;
  padding: 14px;
  font-size: 15px;
  font-weight: bold;
  width: 90%;
  max-width: 320px;
  margin: 6px 0;
  box-shadow: 0 10px 20px rgba(255,106,0,.35);
  cursor: pointer;
}
button.secondary {
  background: linear-gradient(135deg, #4caf50, #2e7d32);
}

/* Puzzle small UI */
.puzzles {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin: 18px auto;
}
.puzzle {
  width: 80px;
  height: 80px;
  background: #ddd;
  border-radius: 12px;
  box-shadow: 0 4px 8px rgba(0,0,0,.2);
}
.puzzle.done {
  background-image: url("puzzle.jpg");
  background-size: 200% 200%;
  animation: unlock .5s ease forwards;
}
@keyframes unlock {
  from { opacity: 0; transform: scale(.7); }
  to { opacity: 1; transform: scale(1); }
}
.p1 { background-position: 0% 0%; }
.p2 { background-position: 100% 0%; }
.p3 { background-position: 0% 100%; }
.p4 { background-position: 100% 100%; }

/* Track container */
.track-wrapper {
  width: 100%;
  max-width: 100%;
  margin: 0 auto;
}
.track-wrapper svg {
  width: 100%;
  display: block;
}

/* Reward overlay */
#rewardOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  display: none;          /* é»˜è®¤éšè— */
  align-items: center;
  justify-content: center;
  z-index: 999;
}
.reward-card {
  background: #fff;
  border-radius: 18px;
  padding: 20px 18px 16px;
  width: 80%;
  max-width: 340px;
  box-shadow: 0 8px 24px rgba(0,0,0,.25);
  text-align: center;
}
.reward-icon {
  font-size: 40px;
  margin-bottom: 8px;
}
.reward-title {
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 4px;
}
.reward-desc {
  font-size: 14px;
  color: #666;
  margin-bottom: 16px;
}
.reward-step {
  font-size: 12px;
  color: #999;
  margin-bottom: 10px;
}
.reward-close-btn {
  background: linear-gradient(135deg, #ff9a00, #ff6a00);
  color: #fff;
  border: none;
  border-radius: 999px;
  padding: 10px 20px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  width: 100%;
}
</style>
</head>

<body>

<!-- Title section -->
<div class="hero">
  <h1>Collectible Puzzle System</h1>
  <p>Complete tasks, earn points, collect puzzles</p>
</div>

<!-- UI Info -->
<div class="progress-card">
  <div><strong>Points</strong><span id="points">0</span></div>
  <div><strong>Steps</strong><span id="step">0</span> / 100</div>
  <div><strong>Puzzle</strong><span id="puzzleCount">0</span> / 4</div>
</div>

<!-- Buttons -->
<button class="secondary" onclick="completeTask()">ğŸ¯ Complete Task (+20)</button>
<button onclick="exchangeSteps()">ğŸš— Exchange Points â†’ Move</button>


<!-- MAP START -->
<div class="track-wrapper">

<svg id="gameSvg" viewBox="0 0 1920 1080" xmlns="http://www.w3.org/2000/svg">

  <!-- Gradient background -->
  <defs>
    <linearGradient id="bgGrad" x1="0" x2="0" y1="0" y2="1">
      <stop offset="0%" stop-color="#d7f6b8"/>
      <stop offset="100%" stop-color="#b2e69f"/>
    </linearGradient>

    <linearGradient id="roadGrad" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="#f2c14e"/>
      <stop offset="100%" stop-color="#ddb142"/>
    </linearGradient>

    <linearGradient id="shadowGrad" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="#b28a36" stop-opacity="0.2"/>
      <stop offset="100%" stop-color="#000" stop-opacity="0"/>
    </linearGradient>

    <!-- çƒŸé›¾æ¨¡ç³Šæ•ˆæœ -->
    <filter id="smokeBlur">
      <feGaussianBlur stdDeviation="4" />
    </filter>
  </defs>

  <!-- Sky -->
  <rect width="1920" height="1080" fill="url(#bgGrad)" />

  <!-- Soft hills -->
  <ellipse cx="500" cy="900" rx="900" ry="300" fill="#b6e29b" />
  <ellipse cx="1400" cy="950" rx="1100" ry="350" fill="#aee092" />
  
  <!-- River -->
  <path d="M300,1080 C500,700 600,700 900,1080 Z"
        fill="#96d6ff" opacity="0.7"/>

  <!-- ROAD SHADOW -->
  <path d="
        M 360 180
        Q 960 120 1560 180
        Q 1680 240 1680 540
        Q 1680 840 1560 900
        Q 960 960 360 900
        Q 240 840 240 540
        Q 240 240 360 180
        Z
        "
        fill="url(#shadowGrad)"
        transform="translate(8,8)" />

  <!-- MAIN ROAD -->
  <path id="road"
        d="
        M 360 180
        Q 960 120 1560 180
        Q 1680 240 1680 540
        Q 1680 840 1560 900
        Q 960 960 360 900
        Q 240 840 240 540
        Q 240 240 360 180
        Z
        "
        fill="url(#roadGrad)"
        stroke="black"
        stroke-width="20"
        stroke-linecap="round"
        stroke-linejoin="round"/>

  <!-- Trees -->
  <g fill="#6dbc42">
    <circle cx="400" cy="300" r="30"/>
    <circle cx="440" cy="320" r="25"/>
    <circle cx="1500" cy="250" r="30"/>
    <circle cx="1450" cy="280" r="30"/>
    <circle cx="1200" cy="800" r="35"/>
    <circle cx="1180" cy="840" r="30"/>
    <circle cx="800" cy="900" r="25"/>
    <circle cx="820" cy="930" r="25"/>
  </g>

  <!-- Houses -->
  <g fill="#fff" stroke="#e44d4d" stroke-width="4">
    <rect x="300" y="280" width="100" height="80"/>
    <polygon points="300,280 350,220 400,280"/>
    
    <rect x="1500" y="700" width="120" height="90"/>
    <polygon points="1500,700 1560,640 1620,700"/>
  </g>

  <!-- Start Marker -->
  <circle cx="360" cy="180" r="20" fill="#ff6a00"/>
  <text x="360" y="185" font-size="20" text-anchor="middle" fill="red">START</text>

  <!-- è½¦ + çƒŸé›¾å®¹å™¨ï¼ˆè½¦åœ¨å‰ï¼ŒçƒŸé›¾åœ¨åï¼‰ -->
  <g id="smokeLayer"></g>

  <!-- SVG çŸ¢é‡å°è½¦ï¼šä»¥ (0,0) ä¸ºä¸­å¿ƒç”» -->
  <g id="car" transform="translate(360 180)">
    <!-- è½¦èº« -->
    <rect x="-32" y="-14" width="64" height="26" rx="8" fill="#ff4a4a"/>
    <!-- è½¦é¡¶ -->
    <rect x="-18" y="-26" width="36" height="16" rx="5" fill="#ffd7d7"/>
    <!-- å‰æŒ¡é£ç»ç’ƒ -->
    <rect x="-12" y="-24" width="14" height="12" rx="3" fill="#ffffff" opacity="0.9"/>
    <!-- åè½¦çª— -->
    <rect x="2" y="-24" width="14" height="12" rx="3" fill="#ffffff" opacity="0.9"/>
    <!-- è½®å­ -->
    <circle cx="-18" cy="14" r="8" fill="#333"/>
    <circle cx="18" cy="14" r="8" fill="#333"/>
    <circle cx="-18" cy="14" r="4" fill="#999"/>
    <circle cx="18" cy="14" r="4" fill="#999"/>
  </g>

</svg>

</div>
<!-- MAP END -->


<!-- Puzzle UI -->
<div class="puzzles">
  <div class="puzzle p1" id="pz1"></div>
  <div class="puzzle p2" id="pz2"></div>
  <div class="puzzle p3" id="pz3"></div>
  <div class="puzzle p4" id="pz4"></div>
</div>

<!-- Reward Overlay -->
<div id="rewardOverlay">
  <div class="reward-card">
    <div class="reward-icon" id="rewardIcon">ğŸ</div>
    <div class="reward-title" id="rewardTitle">Reward unlocked!</div>
    <div class="reward-step" id="rewardStepText">Step 25</div>
    <div class="reward-desc" id="rewardDesc">
      You can claim a surprise gift in your reward center.
    </div>
    <button class="reward-close-btn" onclick="closeReward()">OK</button>
  </div>
</div>


<!-- çº¯åŸç”Ÿ JS æ§åˆ¶è·¯å¾„ + å°è½¦ + çƒŸé›¾ç²’å­ + ç¤¼ç‰©å¼¹çª— -->
<script>
  let points = 0;
  let currentStep = 0;
  let puzzleCount = 0;
  const costPerStep = 10;
  const giftSteps = [25, 50, 75];

  // æ¯ä¸ªç¤¼ç‰©ç‚¹æ˜¾ç¤ºçš„å†…å®¹
  const giftRewards = {
    25: {
      icon: "ğŸ",
      title: "Bronze Surprise",
      desc: "You just reached Step 25! You can unlock a small bonus gift."
    },
    50: {
      icon: "ğŸ§©",
      title: "Puzzle Booster",
      desc: "Halfway there! This reward can be used to boost your puzzle progress."
    },
    75: {
      icon: "ğŸ†",
      title: "Golden Reward",
      desc: "Almost finished! This premium gift can be used for special bonuses."
    }
  };

  const pointsEl = document.getElementById("points");
  const stepEl = document.getElementById("step");
  const puzzleCountEl = document.getElementById("puzzleCount");

  const svg = document.getElementById("gameSvg");
  const path = document.getElementById("road");
  const car = document.getElementById("car");
  const smokeLayer = document.getElementById("smokeLayer");
  const pathLength = path.getTotalLength();

  // Reward overlay elements
  const rewardOverlay = document.getElementById("rewardOverlay");
  const rewardIconEl = document.getElementById("rewardIcon");
  const rewardTitleEl = document.getElementById("rewardTitle");
  const rewardDescEl = document.getElementById("rewardDesc");
  const rewardStepTextEl = document.getElementById("rewardStepText");

  const particles = [];
  const PARTICLE_LIFETIME = 800; // æ¯«ç§’

  function completeTask() {
    points += 20;
    updateUI();
  }

  function exchangeSteps() {
    if (points < costPerStep) {
      alert("Not enough points!");
      return;
    }
    points -= costPerStep;
    currentStep++;

    // ç¤¼ç‰©ç‚¹ï¼šæ˜¾ç¤ºå¥–åŠ±å¼¹çª—
    if (giftSteps.includes(currentStep)) {
      showReward(currentStep);
    }

    if (currentStep === 100) {
      puzzleCount++;
      document.getElementById("pz" + puzzleCount).classList.add("done");
      currentStep = 0;
    }

    updateUI();
    updateCarPosition(true); // true = äº§ç”ŸçƒŸé›¾
  }

  function updateUI() {
    pointsEl.textContent = points;
    stepEl.textContent = currentStep;
    puzzleCountEl.textContent = puzzleCount;
  }

  // åœ¨è·¯å¾„ä¸Šæ ¹æ® currentStep å®šä½å°è½¦ + äº§ç”ŸçƒŸé›¾
  function updateCarPosition(spawnSmokeFlag) {
    const progress = currentStep / 100;      // 0 ~ 1
    const distance = pathLength * progress;
    const pt = path.getPointAtLength(distance);

    // å°è½¦å¹³ç§»åˆ°è·¯å¾„ç‚¹ï¼ˆè½¦æœ¬èº«æ˜¯ä»¥0,0ä¸ºä¸­å¿ƒç”»çš„ï¼‰
    car.setAttribute("transform", `translate(${pt.x} ${pt.y})`);

    if (spawnSmokeFlag) {
      // è®¡ç®—è·¯å¾„æ–¹å‘å‘é‡ï¼ˆç”¨å‰ä¸€ä¸ªç‚¹ç²—ç•¥ç®—æ–¹å‘ï¼‰
      const prevDist = Math.max(0, distance - 20);
      const prevPt = path.getPointAtLength(prevDist);

      const dx = pt.x - prevPt.x;
      const dy = pt.y - prevPt.y;
      const len = Math.sqrt(dx*dx + dy*dy) || 1;
      const nx = dx / len;
      const ny = dy / len;

      // åœ¨å°è½¦åé¢ä¸€ç‚¹ç‚¹çš„ä½ç½®å–·çƒŸï¼ˆåæ–¹å‘ï¼‰
      const smokeX = pt.x - nx * 40;
      const smokeY = pt.y - ny * 40;

      spawnSmoke(smokeX, smokeY);
    }
  }

  // ç”Ÿæˆä¸€é¢—çƒŸé›¾ç²’å­
  function spawnSmoke(x, y) {
    const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
    const jitterX = (Math.random() - 0.5) * 20; // éšæœºæŠ–åŠ¨
    const jitterY = (Math.random() - 0.5) * 10;

    circle.setAttribute("cx", x + jitterX);
    circle.setAttribute("cy", y + jitterY);
    circle.setAttribute("r", 6);
    circle.setAttribute("fill", "#ffffff");
    circle.setAttribute("opacity", "0.7");
    circle.setAttribute("filter", "url(#smokeBlur)");

    smokeLayer.appendChild(circle);

    particles.push({
      el: circle,
      start: performance.now()
    });
  }

  // ç²’å­åŠ¨ç”»å¾ªç¯
  function updateParticles(timestamp) {
    for (let i = particles.length - 1; i >= 0; i--) {
      const p = particles[i];
      const age = timestamp - p.start;
      if (age >= PARTICLE_LIFETIME) {
        // åˆ é™¤ç²’å­
        if (p.el.parentNode) p.el.parentNode.removeChild(p.el);
        particles.splice(i, 1);
        continue;
      }

      const t = age / PARTICLE_LIFETIME; // 0~1
      const newR = 6 + t * 14;           // åŠå¾„å˜å¤§
      const newOpacity = 0.7 * (1 - t);  // é€æ¸é€æ˜

      p.el.setAttribute("r", newR);
      p.el.setAttribute("opacity", newOpacity);

      // è½»å¾®å¾€ä¸Šé£˜
      const cy = parseFloat(p.el.getAttribute("cy"));
      p.el.setAttribute("cy", cy - 0.4);
    }

    requestAnimationFrame(updateParticles);
  }

  // æ˜¾ç¤ºç¤¼ç‰©å¼¹çª—
  function showReward(step) {
    const reward = giftRewards[step] || {
      icon: "ğŸ",
      title: "Special Reward",
      desc: "You just unlocked a special reward!"
    };

    rewardIconEl.textContent = reward.icon;
    rewardTitleEl.textContent = reward.title;
    rewardDescEl.textContent = reward.desc;
    rewardStepTextEl.textContent = `Step ${step}`;

    rewardOverlay.style.display = "flex";
  }

  // å…³é—­ç¤¼ç‰©å¼¹çª—
  function closeReward() {
    rewardOverlay.style.display = "none";
  }

  // åˆå§‹æŠŠè½¦æ”¾åˆ°èµ·ç‚¹ï¼Œå¹¶å¯åŠ¨ç²’å­åŠ¨ç”»å¾ªç¯
  updateCarPosition(false);
  requestAnimationFrame(updateParticles);
</script>

</body>
</html>
